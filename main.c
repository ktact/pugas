#include <stdio.h>
#include <stdlib.h>

/*
 * e_ident
 */
char MAGIC_NUMBER[] = {
  0x7f,
  0x45, /* E */
  0x4c, /* L */
  0x46, /* F */
};

// バイナリのアーキテクチャーを指定する
char EI_CLASS[] = {
  0x02, /* 1: ELF32, 2: ELF64 */
};

// データエンコーディングを指定する
char EI_DATA[] = {
  0x01, /* 1: リトルエンディアン, 2: ビッグエンディアン */
};

// ELF仕様のバージョン番号を指定する
char EI_VERSION[] = {
  0x01, /* 1: カレントバージョン */
};

// オブジェクトのターゲットとなるOSとABIを指定する
char EI_OSABI[] = {
  0x00, /* 0: Linux */
};

// ABIのバージョンを指定する
char EI_ABIVERSION[] = {
  0x00,
};

// パディング
char EI_PAD[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

/*
 * ELFヘッダ
 */
char ELF_HEADERS[] = {
  0x01, 0x00, // e_type: 0x0001=オブジェクト・ファイル(ET_REL)
  0x3e, 0x00, // e_machine
  0x01, 0x00, 0x00, 0x00, // e_version
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // e_entry: 実行可能ファイルの場合には実行開始アドレスが格納される
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // e_phoff: プログラムヘッダテーブルの位置（ファイル先頭からのオフセット）
  0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // e_shoff: セクションヘッダテーブルの位置（ファイル先頭からのオフセット）
  0x00, 0x00, 0x00, 0x00, // e_flags: 未使用
  0x40, 0x00, // e_ehsize: ELFヘッダのサイズ
  0x00, 0x00, // e_phentsize: プログラムヘッダのサイズ
  0x00, 0x00, // e_phnum: プログラムヘッダの個数
  0x40, 0x00, // e_shentsize: セクションヘッダーのサイズ
  0x07, 0x00, // e_shnum: セクションヘッダの個数
  0x06, 0x00, // e_shstrndx
};

/*
 * セクション・ヘッダー・テーブル
 */
char SECTION_HEADER_TABLE[] = {
  // SHT_NULL: このセクションヘッダーに関連付けられたセクションは存在しない(フィールドの値は不定)
  0x00, 0x00, 0x00, 0x00,                         // sh_name
  0x00, 0x00, 0x00, 0x00,                         // sh_type
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_flags
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addr
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_offset
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_size
  0x00, 0x00, 0x00, 0x00,                         // sh_link
  0x00, 0x00, 0x00, 0x00,                         // sh_info
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addralign
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_entsize

  // SHT_PROGBITS(.text)
  0x1b, 0x00, 0x00, 0x00,                         // sh_name:      .shstrtabセクション内の.textの開始位置を示す
  0x01, 0x00, 0x00, 0x00,                         // sh_type:      SHT_PROGBITS
  0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_flags:     SHF_EXECINSTR(実行可能) | SHF_ALLOC(実行形式のロード時にメモリ上に確保される)
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addr:      オブジェクトファイルではロード先アドレスは未定なためゼロ
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_offset:    ELFファイル中でのセクションの位置(先頭からのオフセット)
  0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_size:      セクションのサイズ(バイト)
  0x00, 0x00, 0x00, 0x00,                         // sh_link
  0x00, 0x00, 0x00, 0x00,                         // sh_info
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addralign: ロードされる際のアラインメントのサイズ
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_entsize

  // SHT_PROGBITS(.data)
  0x21, 0x00, 0x00, 0x00,                         // sh_name
  0x01, 0x00, 0x00, 0x00,                         // sh_type:      SH_PROGBITS
  0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_flags:     SHF_ALLOC(実行形式のロード時にメモリ上に確保される) | SHF_WRITE(書込み可能)
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addr
  0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_offset
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_size
  0x00, 0x00, 0x00, 0x00,                         // sh_link
  0x00, 0x00, 0x00, 0x00,                         // sh_info
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addralign
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_entsize

  // SHT_NOBITS(.bss)
  0x27, 0x00, 0x00, 0x00,                         // sh_name
  0x08, 0x00, 0x00, 0x00,                         // sh_type:      SHT_NOBITS(.bss)
  0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_flags:     SHF_ALLOC(実行形式のロード時にメモリ上に確保される) | SHF_WRITE(書込み可能)
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addr
  0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_offset
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_size
  0x00, 0x00, 0x00, 0x00,                         // sh_link
  0x00, 0x00, 0x00, 0x00,                         // sh_info
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addralign
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_entsize

  // SHT_SYMTAB(.symtab)
  0x01, 0x00, 0x00, 0x00,                         // sh_name
  0x02, 0x00, 0x00, 0x00,                         // sh_type:     SHT_SYMTAB
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_flags
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addr
  0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_offset
  0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_size
  0x05, 0x00, 0x00, 0x00,                         // sh_link
  0x04, 0x00, 0x00, 0x00,                         // sh_info
  0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addralign
  0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_entsize

  // SHT_STRTAB(.strtab)
  0x09, 0x00, 0x00, 0x00,                         // sh_name
  0x03, 0x00, 0x00, 0x00,                         // sh_type:     SHT_STRTAB
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_flags
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addr
  0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_offset
  0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_size
  0x00, 0x00, 0x00, 0x00,                         // sh_link
  0x00, 0x00, 0x00, 0x00,                         // sh_info
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addralign
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_entsize

  // SHT_STRTAB(.shstrtab)
  0x11, 0x00, 0x00, 0x00,                         // sh_name
  0x03, 0x00, 0x00, 0x00,                         // sh_type:     SHT_STRTAB
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_flags
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addr
  0xc6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_offset
  0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_size
  0x00, 0x00, 0x00, 0x00,                         // sh_link
  0x00, 0x00, 0x00, 0x00,                         // sh_info
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sh_addralign
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  // sh_entsize
};

int main() {
  char data[] = {
    // .textセクション
    0x48, 0xc7, 0xc0, 0x2a, 0x00, 0x00, 0x00, // mov rax, 42
    0xc3,                                     // ret

    // .symtabセクション
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x02, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x03, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    // .strtabセクション
    0x00, 0x6d, 0x61, 0x69, 0x6e, 0x00, // main

    // .shstrtabセクション
    0x00, 0x2e, 0x73, 0x79, 0x6d, 0x74, 0x61, 0x62,             // .symtab
    0x00, 0x2e, 0x73, 0x74, 0x72, 0x74, 0x61, 0x62,             // .strtab
    0x00, 0x2e, 0x73, 0x68, 0x73, 0x74, 0x72, 0x74, 0x61, 0x62, // .shstrtab
    0x00, 0x2e, 0x74, 0x65, 0x78, 0x74,                         // .text
    0x00, 0x2e, 0x64, 0x61, 0x74, 0x61,                         // .data
    0x00, 0x2e, 0x62, 0x73, 0x73,                               // .bss
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  };

  fwrite(MAGIC_NUMBER,  1, sizeof(MAGIC_NUMBER),  stdout);
  fwrite(EI_CLASS,      1, sizeof(EI_CLASS),      stdout);
  fwrite(EI_DATA,       1, sizeof(EI_DATA),       stdout);
  fwrite(EI_VERSION,    1, sizeof(EI_VERSION),    stdout);
  fwrite(EI_OSABI,      1, sizeof(EI_OSABI),      stdout);
  fwrite(EI_ABIVERSION, 1, sizeof(EI_ABIVERSION), stdout);
  fwrite(EI_PAD,        1, sizeof(EI_PAD),        stdout);

  fwrite(ELF_HEADERS,    1, sizeof(ELF_HEADERS),    stdout);

  fwrite(data, 1, sizeof(data), stdout);

  fwrite(SECTION_HEADER_TABLE, 1, sizeof(SECTION_HEADER_TABLE), stdout);

  return 0;
}
